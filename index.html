
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SalesMaster Pro</title>
    
    <!-- Dependências Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
      body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background: #f9fafb; overflow-x: hidden; }
      
      #app-loader {
        position: fixed;
        inset: 0;
        background: #1e40af;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        z-index: 9999;
        transition: opacity 0.5s ease;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255,255,255,0.1);
        border-top: 4px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      @keyframes spin { to { transform: rotate(360deg); } }
      .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
      .animate-slideUp { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>

    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@1.34.0",
    "react": "https://esm.sh/react@19.0.0",
    "react-dom": "https://esm.sh/react-dom@19.0.0",
    "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="app-loader">
        <div class="spinner"></div>
        <h1 class="text-2xl font-black tracking-tight">SalesMaster Pro</h1>
        <p class="opacity-75 mt-2">Sincronizando banco de dados local...</p>
    </div>

    <div id="root"></div>

    <!-- O segredo aqui é o data-type="module" para permitir imports -->
    <script type="text/babel" data-presets="react,typescript" data-type="module">
      import React, { useState, useEffect, useCallback, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenAI } from "@google/genai";

      // --- 1. BANCO DE DADOS LOCAL ---
      const DB_NAME = 'SalesMasterDB_vFinal';
      const DB_VERSION = 1;

      class LocalDatabase {
        db = null;
        async init() {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (e) => {
              const db = e.target.result;
              ['clients', 'appointments', 'sales', 'users'].forEach(store => {
                if (!db.objectStoreNames.contains(store)) {
                  const os = db.createObjectStore(store, { keyPath: 'id' });
                  if (store !== 'users') os.createIndex('userId', 'userId', { unique: false });
                }
              });
            };
            request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
            request.onerror = () => reject('Erro IndexedDB');
          });
        }
        async getAllForUser(store, userId) {
          if (!this.db) return [];
          return new Promise((resolve) => {
            const tx = this.db.transaction(store, 'readonly');
            const os = tx.objectStore(store);
            const req = os.index('userId').getAll(userId);
            req.onsuccess = () => resolve(req.result);
          });
        }
        async put(store, item) {
          const tx = this.db.transaction(store, 'readwrite');
          tx.objectStore(store).put(item);
          return new Promise((res) => tx.oncomplete = res);
        }
        async delete(store, id) {
          const tx = this.db.transaction(store, 'readwrite');
          tx.objectStore(store).delete(id);
          return new Promise((res) => tx.oncomplete = res);
        }
      }
      const dbService = new LocalDatabase();

      // --- 2. COMPONENTES ---

      const Login = ({ onLogin }) => {
        const [u, setU] = useState('');
        const [p, setP] = useState('');
        const USERS = [
          { id: '1', username: 'admin', name: 'Administrador', password: '123' },
          { id: '4', username: 'Thiago', name: 'Thiago', password: 'Dudinh@2015' }
        ];
        const handle = (e) => {
          e.preventDefault();
          const user = USERS.find(x => x.username === u && x.password === p);
          if (user) onLogin(user); else alert('Usuário ou senha inválidos!');
        };
        return (
          <div className="min-h-screen bg-blue-800 flex items-center justify-center p-6">
            <div className="bg-white p-10 rounded-[3rem] shadow-2xl w-full max-w-md animate-slideUp">
              <div className="text-center mb-8">
                <h1 className="text-3xl font-black text-blue-600">SalesMaster</h1>
                <p className="text-gray-400">Entre com suas credenciais</p>
              </div>
              <form onSubmit={handle} className="space-y-4">
                <input type="text" placeholder="Usuário" className="w-full p-4 bg-gray-50 rounded-2xl border outline-none focus:ring-2 focus:ring-blue-500" onChange={e=>setU(e.target.value)} />
                <input type="password" placeholder="Senha" className="w-full p-4 bg-gray-50 rounded-2xl border outline-none focus:ring-2 focus:ring-blue-500" onChange={e=>setP(e.target.value)} />
                <button className="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-blue-700 transition-all">Entrar</button>
              </form>
            </div>
          </div>
        );
      };

      const Dashboard = ({ user, clients, sales, onUpdate }) => {
        const [modal, setModal] = useState(false);
        const totalVendas = sales.reduce((acc, s) => acc + s.amount, 0);

        const handleSave = async (e) => {
          e.preventDefault();
          const f = new FormData(e.target);
          const sale = {
            id: crypto.randomUUID(),
            userId: user.id,
            clientId: f.get('clientId'),
            clientName: clients.find(c => c.id === f.get('clientId'))?.name || 'Cliente',
            amount: parseFloat(f.get('amount')),
            date: new Date().toISOString().split('T')[0]
          };
          await dbService.put('sales', sale);
          setModal(false); onUpdate();
        };

        return (
          <div className="space-y-6 animate-fadeIn">
            <div className="flex justify-between items-center">
              <h2 className="text-2xl font-black">Olá, {user.name}!</h2>
              <button onClick={()=>setModal(true)} className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold">Nova Venda</button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="bg-white p-6 rounded-3xl border">
                <p className="text-xs font-bold text-gray-400 uppercase">Faturamento</p>
                <p className="text-3xl font-black text-blue-600">R$ {totalVendas.toLocaleString('pt-BR')}</p>
              </div>
              <div className="bg-white p-6 rounded-3xl border">
                <p className="text-xs font-bold text-gray-400 uppercase">Clientes</p>
                <p className="text-3xl font-black">{clients.length}</p>
              </div>
            </div>

            <div className="bg-white rounded-3xl border overflow-hidden">
              <div className="p-6 border-b font-bold">Últimas Vendas</div>
              <table className="w-full text-left">
                <tbody>
                  {sales.map(s => (
                    <tr key={s.id} className="border-b last:border-0 hover:bg-gray-50">
                      <td className="p-4 text-sm font-bold">{s.clientName}</td>
                      <td className="p-4 text-blue-600 font-black">R$ {s.amount.toFixed(2)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {modal && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <form onSubmit={handleSave} className="bg-white p-8 rounded-3xl w-full max-w-md space-y-4">
                  <h3 className="text-xl font-bold">Lançar Venda</h3>
                  <select name="clientId" required className="w-full p-4 bg-gray-50 border rounded-xl">
                    <option value="">Selecione o Cliente</option>
                    {clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                  </select>
                  <input name="amount" type="number" step="0.01" placeholder="Valor" required className="w-full p-4 bg-gray-50 border rounded-xl" />
                  <button type="submit" className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">Salvar</button>
                  <button type="button" onClick={()=>setModal(false)} className="w-full text-gray-400 font-bold">Cancelar</button>
                </form>
              </div>
            )}
          </div>
        );
      };

      // --- 3. APP PRINCIPAL ---
      const App = () => {
        const [user, setUser] = useState(() => {
          const s = sessionStorage.getItem('sm_session');
          return s ? JSON.parse(s) : null;
        });
        const [data, setData] = useState({ clients: [], sales: [] });
        const [ready, setReady] = useState(false);

        const refresh = useCallback(async () => {
          if (!user) return;
          const c = await dbService.getAllForUser('clients', user.id);
          const s = await dbService.getAllForUser('sales', user.id);
          setData({ clients: c, sales: s });
        }, [user]);

        useEffect(() => {
          dbService.init().then(() => {
            refresh();
            setReady(true);
            const loader = document.getElementById('app-loader');
            if (loader) {
              loader.style.opacity = '0';
              setTimeout(() => loader.remove(), 500);
            }
          });
        }, [refresh]);

        if (!user) return <Login onLogin={u => { sessionStorage.setItem('sm_session', JSON.stringify(u)); setUser(u); }} />;
        if (!ready) return null;

        return (
          <div className="min-h-screen bg-gray-50 p-6 md:p-12">
            <div className="max-w-4xl mx-auto">
              <Dashboard user={user} clients={data.clients} sales={data.sales} onUpdate={refresh} />
              <button 
                onClick={() => { sessionStorage.clear(); location.reload(); }}
                className="mt-8 text-gray-400 text-sm font-bold flex items-center gap-2"
              >
                <i className="fas fa-sign-out-alt"></i> Sair do Sistema
              </button>
            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>
